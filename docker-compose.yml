version: '3.8'

services:
  # ============================================
  # 基础设施服务
  # ============================================

  # MySQL 8.0 - 核心业务数据库
  traffic-db:
    image: mysql:8.0
    container_name: traffic_db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      TZ: ${TIMEZONE}
    ports:
      - "3307:3306"
    volumes:
      # 数据持久化：挂载本地数据目录到容器
      - ./mysql/data:/var/lib/mysql
      # 初始化脚本：容器首次启动时自动执行SQL
      - ./mysql/init:/docker-entrypoint-initdb.d
    networks:
      - traffic-network
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=mysql_native_password
      - --init-connect=SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci
      - --skip-character-set-client-handshake
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Adminer - 轻量级数据库管理Web界面
  db-admin:
    image: adminer:latest
    container_name: traffic_db_admin
    restart: always
    ports:
      - "8080:8080"
    networks:
      - traffic-network
    depends_on:
      - traffic-db
    environment:
      ADMINER_DEFAULT_SERVER: traffic-db

  # Redis - 缓存及Token存储
  redis:
    image: redis:7-alpine
    container_name: traffic_redis
    restart: always
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      # 数据持久化：使用AOF日志
      - ./redis/data:/data
    networks:
      - traffic-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MinIO - 对象存储服务（用于存储违章图片）
  minio:
    image: minio/minio:latest
    container_name: traffic_minio
    restart: always
    ports:
      - "9000:9000"  # MinIO API接口
      - "9001:9001"  # MinIO Web管理界面（Console）
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      TZ: ${TIMEZONE}
    volumes:
      # 数据持久化：挂载本地数据目录
      - ./minio/data:/minio/data
    networks:
      - traffic-network
    command: server /minio/data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # 应用服务
  # ============================================

  # Python AI 检测服务
  ai-service:
    build:
      context: .
      dockerfile: ai_detection/Dockerfile
    image: traffic-mind-ai:latest
    container_name: traffic_ai
    restart: always
    user: "1001:1001"  # 以服务器用户身份运行，避免文件权限问题
    ports:
      - "5000:5000"
    volumes:
      # 文件上传共享目录
      - ./uploads:/app/uploads
      # AI检测数据目录
      - ./ai_detection/data:/app/data
      # 临时视频目录
      - ./ai_detection/temp_videos:/app/temp_videos
      # 输出视频目录
      - ./ai_detection/output:/app/output
      # 违规截图目录
      - ./ai_detection/output/screenshots:/app/output/screenshots
      # 日志目录
      - ./logs/ai:/app/logs

    networks:
      - traffic-network
    depends_on:
      traffic-db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # 时区配置
      - TZ=${TIMEZONE}
      # 后端API地址（容器内网络）
      - BACKEND_API_URL=http://backend:8081/api
      - BACKEND_BASE_URL=http://backend:8081/api
      - MINIO_ENDPOINT=http://minio:9000
      # 路口ID
      - INTERSECTION_ID=1
      # Python 配置
      - PYTHONUNBUFFERED=1

  # Java Spring Boot 后端服务
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    image: traffic-mind-backend:latest
    container_name: traffic_backend
    restart: always
    user: "1001:1001"  # 以服务器用户身份运行，避免文件权限问题
    ports:
      - "8081:8081"
    volumes:
      # 文件上传共享目录
      - ./uploads:/app/uploads
      # 日志目录
      - ./logs/backend:/app/logs
    networks:
      - traffic-network
    depends_on:
      traffic-db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # 时区配置
      - TZ=${TIMEZONE}

      # 数据库配置
      - SPRING_DATASOURCE_URL=jdbc:mysql://traffic-db:3306/${MYSQL_DATABASE}?useSSL=false&serverTimezone=Asia/Shanghai&characterEncoding=UTF-8&allowPublicKeyRetrieval=true
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_ROOT_PASSWORD}

      # Redis 配置
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379

      # JWT 配置
      - JWT_SECRET=${JWT_SECRET:-TrafficMindSecretKeyForJWTTokenGenerationAndValidation2024_MakeItLongerThan512BitsForHS512SecurityStandard}

      # AI 服务配置
      # AI_SERVICE_BASE_URL 用于图像检测服务 (Docker 内 ai-service)
      - AI_SERVICE_BASE_URL=http://ai-service:5000
      - AI_SERVICE_URL=http://ai-service:5000
      # LLM_SERVICE_BASE_URL 用于信号控制服务 (autodl 上的 LLM)
      - LLM_SERVICE_BASE_URL=https://u836978-a67f-943bbb9f.westc.gpuhub.com:8443

      # 文件存储配置
      - FILE_UPLOAD_BASE_PATH=/app/uploads
      - FILE_URL_BASE_URL=http://47.107.50.136:8081/api/files

      # JVM 配置
      - JAVA_OPTS=-Xms512m -Xmx2g -XX:+UseG1GC -Duser.timezone=Asia/Shanghai

      # Spring Profile
      - SPRING_PROFILES_ACTIVE=prod

networks:
  traffic-network:
    driver: bridge

# ============================================
# 数据卷（可选，如果使用命名卷）
# ============================================
volumes:
  mysql-data:
  redis-data:
  minio-data:
