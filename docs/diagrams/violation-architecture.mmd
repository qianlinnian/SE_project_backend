%% Violation & Law Enforcement Module - Classical 4-Layer Architecture
graph TB
    subgraph Presentation["Presentation Layer (è¡¨çŽ°å±‚)"]
        PoliceApp["ðŸ‘® Police App / Web\n(case handling,\nviolation review)"]
        AdminDash["ðŸ‘¤ Admin Dashboard\n(reporting, audit)"]
        AlertPanel["ðŸš¨ Alert Panel\n(real-time WebSocket)"]
    end

    subgraph Business["Business Logic Layer (ä¸šåŠ¡é€»è¾‘å±‚)"]
        ViolationCtrl["ViolationController\n- reportViolation()\n- getViolations(page, size)\n- getViolationDetail(id)\n- processViolation(id, info)"]
        ViolationService["ViolationService\n- reportViolation(data)\n- getViolationDetail(id)\n- processViolation(id, info)\n- entity <-> map conversion\n- cache/DB sync"]
    end

    subgraph Data["Data Access Layer (æ•°æ®è®¿é—®å±‚)"]
        ViolationRepo["ViolationRepository\n- save(violation)\n- findById(id)\n- findAll(page)"]
        RedisViolService["RedisService (Violations)\n- violation:{id}\n- violations:list\n- violation:total:today"]
    end

    subgraph Infrastructure["Infrastructure Layer (åŸºç¡€è®¾æ–½å±‚)"]
        MySQL["ðŸŸ¢ MySQL Database\n(Violation entity,\nstatus, processedAt,\npenaltyAmount, etc.)"]
        Redis["ðŸ”´ Redis Cache\n(violation:{id},\nviolations:list,\ncounters)"]
        WebSocket["ðŸ“¡ WebSocket\nAlertWebSocketHandler\n(/ws/alerts)"]
        OSS["â˜ï¸ Object Storage\n(evidence images)"]
        Camera["ðŸ“· Cameras / AI\n(violation detection,\nevidence upload)"]
    end

    %% Presentation -> Business
    PoliceApp -->|GET /api/violations| ViolationCtrl
    PoliceApp -->|GET /api/violations/{id}| ViolationCtrl
    PoliceApp -->|PUT /api/violations/{id}/process| ViolationCtrl
    AdminDash -->|GET /api/violations\n(statistics, audit)| ViolationCtrl
    AlertPanel -->|WebSocket /ws/alerts\n(subscribe)| WebSocket

    %% Business -> Data
    ViolationCtrl --> ViolationService
    ViolationService --> ViolationRepo
    ViolationService --> RedisViolService

    %% Data -> Infrastructure
    ViolationRepo --> MySQL
    RedisViolService --> Redis
    ViolationService --> WebSocket

    %% Infrastructure
    Camera -->|POST /api/violations/report\n(intersectionId, plate, type,\nimageUrl, aiConfidence)| ViolationCtrl
    OSS -->|store evidence images| Camera
    WebSocket -->|push alerts| PoliceApp
    WebSocket -->|push alerts| AlertPanel

    %% Styling
    classDef presentation fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef business fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef data fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef infrastructure fill:#e0f2f1,stroke:#00796b,stroke-width:2px

    class PoliceApp,AdminDash,AlertPanel presentation
    class ViolationCtrl,ViolationService business
    class ViolationRepo,RedisViolService data
    class MySQL,Redis,WebSocket,OSS,Camera infrastructure
