<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI äº¤é€šæ£€æµ‹æ¼”ç¤º</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
    }

    .header h1 {
      margin-bottom: 10px;
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid #e0e0e0;
      background: #fafafa;
    }

    .tab {
      padding: 15px 30px;
      cursor: pointer;
      border: none;
      background: transparent;
      font-size: 16px;
      transition: all 0.3s;
    }

    .tab:hover {
      background: #f0f0f0;
    }

    .tab.active {
      background: white;
      border-bottom: 3px solid #667eea;
      color: #667eea;
      font-weight: bold;
    }

    .content {
      padding: 30px;
      display: none;
    }

    .content.active {
      display: block;
    }

    .section {
      margin-bottom: 30px;
    }

    .section h3 {
      margin-bottom: 15px;
      color: #333;
    }

    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }

    button:hover {
      background: #5568d3;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    input[type="file"],
    input[type="text"] {
      padding: 8px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 5px;
      font-size: 14px;
      margin-right: 10px;
    }

    .preview-image,
    .result-image {
      max-width: 100%;
      margin-top: 15px;
      border-radius: 5px;
      border: 2px solid #e0e0e0;
    }

    .violation-list {
      margin-top: 15px;
    }

    .violation-item {
      padding: 15px;
      background: #f9f9f9;
      border-left: 4px solid #f44336;
      margin-bottom: 10px;
      border-radius: 3px;
    }

    .violation-item .type {
      display: inline-block;
      padding: 4px 12px;
      background: #f44336;
      color: white;
      border-radius: 12px;
      font-size: 12px;
      margin-right: 10px;
    }

    .status-indicator {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      margin-bottom: 15px;
    }

    .status-indicator.connected {
      background: #4caf50;
      color: white;
    }

    /* çº¢ç»¿ç¯æ ·å¼ */
    .signal-panel {
      background: #1a1a2e;
      border-radius: 10px;
      padding: 15px 20px;
      margin: 15px 0;
      display: inline-block;
    }

    .signal-panel h4 {
      margin: 0 0 10px 0;
      color: #fff;
      font-size: 14px;
    }

    .signal-lights {
      display: flex;
      gap: 20px;
    }

    .signal-direction {
      text-align: center;
    }

    .signal-direction-name {
      color: #888;
      font-size: 12px;
      margin-bottom: 5px;
    }

    .signal-light {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      margin: 3px auto;
      border: 2px solid #444;
      transition: all 0.3s ease;
    }

    .signal-light.red {
      background: #440000;
      box-shadow: none;
    }

    .signal-light.red.active {
      background: #ff0000;
      box-shadow: 0 0 20px #ff0000, 0 0 40px #ff0000;
    }

    .signal-light.green {
      background: #004400;
      box-shadow: none;
    }

    .signal-light.green.active {
      background: #00ff00;
      box-shadow: 0 0 20px #00ff00, 0 0 40px #00ff00;
    }

    .signal-light.yellow {
      background: #444400;
      box-shadow: none;
    }

    .signal-light.yellow.active {
      background: #ffff00;
      box-shadow: 0 0 20px #ffff00, 0 0 40px #ffff00;
    }

    .signal-left-turn {
      width: 24px;
      height: 24px;
      font-size: 10px;
      line-height: 24px;
      color: #666;
    }

    .status-indicator.disconnected {
      background: #f44336;
      color: white;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .error {
      padding: 15px;
      background: #ffebee;
      color: #c62828;
      border-radius: 5px;
      margin-top: 15px;
    }

    .success {
      padding: 15px;
      background: #e8f5e9;
      color: #2e7d32;
      border-radius: 5px;
      margin-top: 15px;
    }

    .video-frame {
      position: relative;
      background: #000;
      border-radius: 5px;
      overflow: hidden;
      min-height: 360px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .video-frame img {
      max-width: 100%;
      display: block;
    }

    .placeholder {
      color: #999;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- å¤´éƒ¨ -->
    <div class="header">
      <h1>ğŸš— AI äº¤é€šæ£€æµ‹æ¼”ç¤º</h1>
      <p>TrafficMind - æ™ºèƒ½äº¤é€šè¿è§„æ£€æµ‹ç³»ç»Ÿ</p>
    </div>

    <!-- æ ‡ç­¾é¡µ -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('image')">ğŸ“¸ å›¾ç‰‡æ£€æµ‹</button>
      <button class="tab" onclick="switchTab('realtime')">ğŸ¥ å®æ—¶ç›‘æ§</button>
    </div>

    <!-- å›¾ç‰‡æ£€æµ‹å†…å®¹ -->
    <div id="image-content" class="content active">
      <div class="section">
        <h3>ä¸Šä¼ å›¾ç‰‡</h3>
        <input type="file" id="imageInput" accept="image/*">
        <button onclick="detectImage()">å¼€å§‹æ£€æµ‹</button>
      </div>

      <div id="imagePreview" class="section" style="display: none;">
        <h3>é¢„è§ˆ</h3>
        <img id="previewImg" class="preview-image">
      </div>

      <div id="imageLoading" class="loading" style="display: none;">
        æ£€æµ‹ä¸­ï¼Œè¯·ç¨å€™...
      </div>

      <div id="imageError" class="error" style="display: none;"></div>

      <div id="imageResult" class="section" style="display: none;">
        <h3>æ£€æµ‹ç»“æœ</h3>
        <p id="resultSummary"></p>
        <img id="resultImg" class="result-image">
        <div id="violationList" class="violation-list"></div>
      </div>
    </div>

    <!-- å®æ—¶ç›‘æ§å†…å®¹ -->
    <div id="realtime-content" class="content">
      <!-- æ­¥éª¤ 1: ä¸Šä¼ è§†é¢‘ -->
      <div class="section" id="uploadSection">
        <h3>ğŸ“¹ æ­¥éª¤ 1: ä¸Šä¼ è§†é¢‘æ–‡ä»¶</h3>
        <input type="file" id="videoInput" accept="video/*" onchange="handleVideoSelect()">
        <div id="videoInfo" style="margin-top: 10px; display: none; color: #666;">
          <p id="videoName"></p>
          <p id="videoSize"></p>
        </div>
        <button id="startBtn" onclick="startVideoDetection()" disabled style="margin-top: 10px;">
          ğŸš€ å¼€å§‹æ£€æµ‹
        </button>
      </div>

      <!-- æ­¥éª¤ 2: è¿æ¥çŠ¶æ€ -->
      <div class="section">
        <span id="wsStatus" class="status-indicator disconnected">æœªè¿æ¥</span>
        <span id="wsProgress" style="margin-left: 15px; color: #666;"></span>
        <span id="wsTaskId" style="margin-left: 15px; color: #666;"></span>
      </div>

      <!-- çº¢ç»¿ç¯çŠ¶æ€é¢æ¿ -->
      <div class="section">
        <div class="signal-panel">
          <h4>ğŸš¦ ä¿¡å·ç¯çŠ¶æ€</h4>
          <div class="signal-lights">
            <!-- åŒ—å‘ -->
            <div class="signal-direction">
              <div class="signal-direction-name">åŒ—å‘</div>
              <div id="signal-north" class="signal-light red active"></div>
              <div id="signal-north-left" class="signal-light red"></div>
            </div>
            <!-- å—å‘ -->
            <div class="signal-direction">
              <div class="signal-direction-name">å—å‘</div>
              <div id="signal-south" class="signal-light red active"></div>
              <div id="signal-south-left" class="signal-light red"></div>
            </div>
            <!-- è¥¿å‘ -->
            <div class="signal-direction">
              <div class="signal-direction-name">è¥¿å‘</div>
              <div id="signal-west" class="signal-light red active"></div>
              <div id="signal-west-left" class="signal-light red"></div>
            </div>
            <!-- ä¸œå‘ -->
            <div class="signal-direction">
              <div class="signal-direction-name">ä¸œå‘</div>
              <div id="signal-east" class="signal-light red active"></div>
              <div id="signal-east-left" class="signal-light red"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>å®æ—¶ç”»é¢</h3>
        <div id="videoFrame" class="video-frame">
          <div class="placeholder">ç­‰å¾…è¿æ¥...</div>
        </div>
      </div>

      <div class="section">
        <h3>å®æ—¶è¿è§„å‘Šè­¦</h3>
        <div id="realtimeViolations" class="violation-list">
          <p style="color: #999;">æš‚æ— è¿è§„è®°å½•</p>
        </div>
      </div>
    </div>
  </div>

  <!-- å¼•å…¥ Socket.IO å®¢æˆ·ç«¯ -->
  <script src="https://cdn.socket.io/4.8.0/socket.io.min.js"></script>

  <script>
    const API_BASE = 'http://localhost:5000';
    let socket = null;

    // ==================== å›¾ç‰‡æ£€æµ‹åŠŸèƒ½ ====================

    // ç›‘å¬æ–‡ä»¶é€‰æ‹©
    document.getElementById('imageInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('previewImg').src = e.target.result;
          document.getElementById('imagePreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });

    // æ£€æµ‹å›¾ç‰‡
    async function detectImage() {
      const fileInput = document.getElementById('imageInput');
      const file = fileInput.files[0];

      if (!file) {
        alert('è¯·å…ˆé€‰æ‹©å›¾ç‰‡');
        return;
      }

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      document.getElementById('imageLoading').style.display = 'block';
      document.getElementById('imageError').style.display = 'none';
      document.getElementById('imageResult').style.display = 'none';

      // åˆ›å»º FormData
      const formData = new FormData();
      formData.append('image', file);

      try {
        const response = await fetch(`${API_BASE}/detect-image`, {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        // éšè—åŠ è½½çŠ¶æ€
        document.getElementById('imageLoading').style.display = 'none';

        if (data.success) {
          // æ˜¾ç¤ºç»“æœ
          document.getElementById('resultSummary').textContent =
            `æ£€æµ‹åˆ° ${data.total_violations} ä¸ªè¿è§„`;

          document.getElementById('resultImg').src =
            `data:image/jpeg;base64,${data.annotated_image}`;

          // æ˜¾ç¤ºè¿è§„åˆ—è¡¨
          const violationList = document.getElementById('violationList');
          violationList.innerHTML = '';

          data.violations.forEach((v, index) => {
            const item = document.createElement('div');
            item.className = 'violation-item';
            item.innerHTML = `
              <span class="type">${getViolationTypeName(v.type)}</span>
              <strong>è½¦è¾†ID:</strong> ${v.track_id} |
              <strong>æ–¹å‘:</strong> ${v.direction} |
              <strong>ç½®ä¿¡åº¦:</strong> ${(v.confidence * 100).toFixed(1)}%
            `;
            violationList.appendChild(item);
          });

          document.getElementById('imageResult').style.display = 'block';
        } else {
          showError('æ£€æµ‹å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (error) {
        document.getElementById('imageLoading').style.display = 'none';
        showError('ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + error.message);
      }
    }

    function showError(message) {
      const errorDiv = document.getElementById('imageError');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }

    // ==================== å®æ—¶ç›‘æ§åŠŸèƒ½ ====================

    let selectedVideo = null;

    // å¤„ç†è§†é¢‘é€‰æ‹©
    function handleVideoSelect() {
      const input = document.getElementById('videoInput');
      selectedVideo = input.files[0];

      if (selectedVideo) {
        document.getElementById('videoName').textContent = 'âœ… å·²é€‰æ‹©: ' + selectedVideo.name;
        document.getElementById('videoSize').textContent =
          'å¤§å°: ' + (selectedVideo.size / 1024 / 1024).toFixed(2) + ' MB';
        document.getElementById('videoInfo').style.display = 'block';
        document.getElementById('startBtn').disabled = false;
      }
    }

    // å¯åŠ¨è§†é¢‘æ£€æµ‹
    async function startVideoDetection() {
      if (!selectedVideo) {
        alert('è¯·å…ˆé€‰æ‹©è§†é¢‘æ–‡ä»¶');
        return;
      }

      const startBtn = document.getElementById('startBtn');
      startBtn.disabled = true;
      startBtn.textContent = 'ä¸Šä¼ ä¸­...';

      const taskId = `task_${Date.now()}`;
      const formData = new FormData();
      formData.append('video', selectedVideo);
      formData.append('taskId', taskId);
      formData.append('intersectionId', '1');
      formData.append('direction', 'SOUTH');

      try {
        const response = await fetch(`${API_BASE}/upload-video`, {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          const data = await response.json();
          console.log('âœ… ä»»åŠ¡å·²å¯åŠ¨:', data);
          document.getElementById('wsTaskId').textContent = 'ä»»åŠ¡ID: ' + taskId;

          // éšè—ä¸Šä¼ åŒºåŸŸ
          document.getElementById('uploadSection').style.display = 'none';

          // å¯åŠ¨ WebSocket è¿æ¥
          startRealtime(taskId);
        } else {
          alert('è§†é¢‘ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦æ”¯æŒ /upload-video æ¥å£');
          startBtn.disabled = false;
          startBtn.textContent = 'ğŸš€ å¼€å§‹æ£€æµ‹';
        }
      } catch (error) {
        console.error('å¯åŠ¨å¤±è´¥:', error);
        alert('å¯åŠ¨å¤±è´¥: ' + error.message);
        startBtn.disabled = false;
        startBtn.textContent = 'ğŸš€ å¼€å§‹æ£€æµ‹';
      }
    }

    function startRealtime(taskId) {
      if (socket && socket.connected) {
        console.log('Socket å·²è¿æ¥ï¼Œè®¢é˜…æ–°ä»»åŠ¡');
        socket.emit('subscribe', { taskId });
        return;
      }

      // åˆ›å»º Socket.IO è¿æ¥
      socket = io(API_BASE, {
        transports: ['websocket']
      });

      // è¿æ¥æˆåŠŸ
      socket.on('connect', () => {
        console.log('âœ… WebSocket å·²è¿æ¥');
        document.getElementById('wsStatus').textContent = 'å·²è¿æ¥';
        document.getElementById('wsStatus').className = 'status-indicator connected';

        // è®¢é˜…ä»»åŠ¡
        socket.emit('subscribe', { taskId });
      });

      // è¿æ¥æ–­å¼€
      socket.on('disconnect', () => {
        console.log('âŒ WebSocket å·²æ–­å¼€');
        document.getElementById('wsStatus').textContent = 'æœªè¿æ¥';
        document.getElementById('wsStatus').className = 'status-indicator disconnected';
      });

      // æ¥æ”¶å®æ—¶å¸§
      socket.on('frame', (data) => {
        console.log('ğŸ“¸ æ”¶åˆ°å¸§:', data.frameNumber);

        // æ›´æ–°è¿›åº¦
        document.getElementById('wsProgress').textContent =
          `è¿›åº¦: ${data.progress.toFixed(1)}% | å¸§å·: ${data.frameNumber}`;

        // æ›´æ–°ç”»é¢
        const videoFrame = document.getElementById('videoFrame');
        videoFrame.innerHTML = `
          <img src="data:image/jpeg;base64,${data.image}" alt="å®æ—¶ç”»é¢">
        `;
      });

      // æ¥æ”¶è¿è§„å‘Šè­¦
      socket.on('violation', (data) => {
        console.log('ğŸš¨ æ£€æµ‹åˆ°è¿è§„:', data.violation);
        addViolationToList(data.violation);
      });

      // ä»»åŠ¡å®Œæˆ
      socket.on('complete', () => { 
        console.log('è§†é¢‘å¤„ç†å®Œæˆ!');
      });

      // é”™è¯¯å¤„ç†
      socket.on('error', (error) => {
        console.error('é”™è¯¯:', error);
        alert('å‘ç”Ÿé”™è¯¯: ' + error);
      });

      // æ¥æ”¶ä¿¡å·ç¯çŠ¶æ€
      socket.on('traffic', (data) => {
        console.log('ğŸš¦ æ”¶åˆ°ä¿¡å·ç¯çŠ¶æ€:', data);
        updateSignalLights(data);
      });
    }

    // æ›´æ–°ä¿¡å·ç¯æ˜¾ç¤º
    function updateSignalLights(data) {
      // æ˜ å°„åç«¯æ–¹å‘åˆ°å‰ç«¯ID
      const directionMap = {
        'north_bound': 'north',
        'south_bound': 'south',
        'west_bound': 'west',
        'east_bound': 'east'
      };

      // æ›´æ–°ç›´è¡Œç¯
      for (const [backendDir, state] of Object.entries(data)) {
        const frontendDir = directionMap[backendDir];
        if (frontendDir) {
          const lightEl = document.getElementById(`signal-${frontendDir}`);
          if (lightEl) {
            // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
            lightEl.classList.remove('red', 'green', 'yellow', 'active');
            // æ·»åŠ æ–°çš„çŠ¶æ€ç±»
            lightEl.classList.add(state, 'active');
          }
        }
      }
    }

    function stopRealtime() {
      if (socket) {
        socket.disconnect();
        socket = null;
      }
    }

    function addViolationToList(violation) {
      const container = document.getElementById('realtimeViolations');

      // ç¬¬ä¸€æ¬¡æ·»åŠ æ—¶æ¸…ç©ºå ä½æ–‡å­—
      if (container.children.length === 1 && container.textContent.includes('æš‚æ— ')) {
        container.innerHTML = '';
      }

      const item = document.createElement('div');
      item.className = 'violation-item';
      item.innerHTML = `
        <span class="type">${getViolationTypeName(violation.type)}</span>
        <strong>è½¦è¾†ID:</strong> ${violation.track_id} |
        <strong>æ–¹å‘:</strong> ${violation.direction}
        ${violation.confidence !== undefined ? `| <strong>ç½®ä¿¡åº¦:</strong> ${(violation.confidence * 100).toFixed(0)}%` : ''}
      `;

      // æ·»åŠ åˆ°é¡¶éƒ¨
      container.insertBefore(item, container.firstChild);

      // åªä¿ç•™æœ€è¿‘ 10 æ¡
      while (container.children.length > 10) {
        container.removeChild(container.lastChild);
      }
    }

    // ==================== å·¥å…·å‡½æ•° ====================

    function switchTab(tab) {
      // æ›´æ–°æ ‡ç­¾çŠ¶æ€
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');

      // æ›´æ–°å†…å®¹æ˜¾ç¤º
      document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
      document.getElementById(tab + '-content').classList.add('active');
    }

    function getViolationTypeName(type) {
      const names = {
        'red_light': 'é—¯çº¢ç¯',
        'wrong_way': 'é€†è¡Œ',
        'lane_change': 'å‹çº¿å˜é“'
      };
      return names[type] || type;
    }

    // é¡µé¢åŠ è½½å®Œæˆæç¤º
    window.addEventListener('load', () => {
      console.log('âœ… é¡µé¢åŠ è½½å®Œæˆ');
      console.log('ğŸ“¡ åç«¯åœ°å€:', API_BASE);
      console.log('ğŸ’¡ è¯·ç¡®ä¿åç«¯å·²å¯åŠ¨: python ai_detection/api/detection_api.py');
    });
  </script>
</body>
</html>
