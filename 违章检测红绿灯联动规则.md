# 🚦 违章检测与红绿灯联动规则

## 📋 违章类型与红绿灯状态关联

| 违章类型     | 红绿灯依赖 | 违章判定规则         | 说明                       |
| ------------ | ---------- | -------------------- | -------------------------- |
| **闯红灯**   | ✅ 强依赖   | 仅红灯时构成违章     | 绿灯/黄灯时不构成违章      |
| **违法转弯** | ✅ 强依赖   | 红灯或黄灯时构成违章 | 绿灯时转弯合法，不构成违章 |
| **逆行**     | ❌ 不依赖   | 始终构成违章         | 不受红绿灯状态影响         |
| **跨实线**   | ❌ 不依赖   | 始终构成违章         | 不受红绿灯状态影响         |

## 🔍 违法转弯详细规则

### 什么是违法转弯？
违法转弯指的是**在非法时间进入待转区域**（即非法时间踩过线），具体包括：

- 🚫 **红灯时**：车辆越过停止线进入待转区域
- 🚫 **黄灯时**：新车辆越过停止线进入待转区域  
- ✅ **绿灯时**：车辆可以合法进入待转区域转弯

### 技术实现逻辑
```java
case "ILLEGAL_TURN":
    // 违法转弯：在非法时间进入待转区域（非法时间踩过线）
    // 红灯或黄灯时进入待转区域构成违章，绿灯时不构成违章
    return trafficLightStateService.isRedLight(intersectionId, violationTime) ||
           trafficLightStateService.isYellowLight(intersectionId, violationTime);
```

## 🎯 实际应用场景

### 场景1：红灯时违法转弯
```json
{
  "intersectionId": 1,
  "plateNumber": "沪A12345",
  "violationType": "违法转弯",
  "imageUrl": "违章证据图片",
  "confidence": 0.92
}
```
**结果**：✅ 构成违章，成功保存记录

### 场景2：绿灯时"违法转弯"
```json
{
  "intersectionId": 1,
  "plateNumber": "沪B67890", 
  "violationType": "违法转弯",
  "imageUrl": "转弯证据图片",
  "confidence": 0.95
}
```
**结果**：❌ 不构成违章，系统拒绝并返回"在当前红绿灯状态下不构成违章"

### 场景3：黄灯时违法转弯
```json
{
  "intersectionId": 1,
  "plateNumber": "沪C11111",
  "violationType": "违法转弯", 
  "imageUrl": "黄灯转弯证据",
  "confidence": 0.88
}
```
**结果**：✅ 构成违章，黄灯时新进入待转区域违法

## 🔧 大模型对接建议

### 检测逻辑优化
你的AI检测模型在识别转弯行为时，建议：

1. **精确时间戳**：提供准确的违章发生时间
2. **行为识别**：区分"进入待转区域"vs"在待转区域内转弯"
3. **场景描述**：在description字段中说明具体违章行为

### 推荐数据格式
```json
{
  "intersectionId": 1,
  "plateNumber": "检测车牌",
  "violationType": "违法转弯",
  "imageUrl": "证据图片URL", 
  "confidence": 0.92,
  "timestamp": 1703001234567,  // 精确的违章时间
  "description": "红灯时越线进入左转待转区域",
  "metadata": {
    "lightPhase": "detected_by_ai",  // AI检测到的灯色（可选）
    "turnDirection": "left",         // 转弯方向（可选）
    "actionType": "entering_zone"    // 行为类型（可选）
  }
}
```

## 📊 系统响应说明

### 成功保存违章
```json
{
  "success": true,
  "violationId": 123,
  "violationType": "ILLEGAL_TURN",
  "lightState": "RED",
  "message": "违章检测结果已保存"
}
```

### 不构成违章
```json
{
  "success": false, 
  "message": "在当前红绿灯状态下不构成违章: ILLEGAL_TURN",
  "reason": "当前红绿灯状态下不构成违章",
  "lightState": "GREEN"
}
```

## 🧪 测试验证

使用提供的测试用例验证联动功能：

1. **设置红绿灯状态**：`POST /api/violation-detection/simulate-light`
2. **上传违法转弯检测**：`POST /api/violation-detection/detect-frame` 
3. **查询处理结果**：`GET /api/violations`
4. **验证灯色状态**：`GET /api/violation-detection/light-state/{intersectionId}`

## ⚡ 性能特性

- **智能缓存**：红绿灯状态缓存10秒，减少数据库查询
- **实时联动**：信号灯调整后，违章检测立即生效  
- **批量处理**：支持批量检测时的红绿灯验证
- **错误处理**：优雅处理无信号灯配置的路口

转弯违规现在已经完全与红绿灯时序联动！🎉