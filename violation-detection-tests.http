###############################################
# 综合违章检测API测试
# 支持视频帧分析、图片上传、红绿灯状态验证
###############################################

### 1. 模拟红绿灯状态 - 设置为红灯
POST http://localhost:8081/api/violation-detection/simulate-light
Content-Type: application/x-www-form-urlencoded

intersectionId=1&lightState=RED&duration=120

### 2. 查询当前红绿灯状态
GET http://localhost:8081/api/violation-detection/light-state/1

### 3. 视频帧检测 - 闯红灯（红灯状态下应该构成违章）
POST http://localhost:8081/api/violation-detection/detect-frame
Content-Type: application/json

{
  "intersectionId": 1,
  "plateNumber": "沪A12345",
  "violationType": "闯红灯",
  "imageUrl": "http://localhost:9000/traffic-violations/violation_20241219_001.jpg",
  "confidence": 0.95,
  "cameraId": "cam-001",
  "timestamp": 1703001234567
}

### 4. 模拟红绿灯状态 - 设置为绿灯
POST http://localhost:8081/api/violation-detection/simulate-light
Content-Type: application/x-www-form-urlencoded

intersectionId=1&lightState=GREEN&duration=60

### 5. 视频帧检测 - 闯红灯（绿灯状态下不应该构成违章）
POST http://localhost:8081/api/violation-detection/detect-frame
Content-Type: application/json

{
  "intersectionId": 1,
  "plateNumber": "沪B67890",
  "violationType": "闯红灯",
  "imageUrl": "http://localhost:9000/traffic-violations/violation_20241219_002.jpg",
  "confidence": 0.92,
  "cameraId": "cam-001"
}

### 6. 视频帧检测 - 逆行（不受红绿灯状态影响，始终违章）
POST http://localhost:8081/api/violation-detection/detect-frame
Content-Type: application/json

{
  "intersectionId": 1,
  "plateNumber": "沪C11111",
  "violationType": "逆行",
  "imageUrl": "http://localhost:9000/traffic-violations/violation_20241219_003.jpg",
  "confidence": 0.88,
  "cameraId": "cam-001"
}

### 7. 视频帧检测 - 跨实线
POST http://localhost:8081/api/violation-detection/detect-frame
Content-Type: application/json

{
  "intersectionId": 1,
  "plateNumber": "沪D22222",
  "violationType": "跨实线",
  "imageUrl": "http://localhost:9000/traffic-violations/violation_20241219_004.jpg",
  "confidence": 0.93,
  "cameraId": "cam-002"
}

### 8. 视频帧检测 - 违法转弯
POST http://localhost:8081/api/violation-detection/detect-frame
Content-Type: application/json

{
  "intersectionId": 1,
  "plateNumber": "沪E33333",
  "violationType": "违法转弯",
  "imageUrl": "http://localhost:9000/traffic-violations/violation_20241219_005.jpg",
  "confidence": 0.90,
  "cameraId": "cam-003"
}

### 9. 批量检测
POST http://localhost:8081/api/violation-detection/detect-batch
Content-Type: application/json

{
  "violations": [
    {
      "intersectionId": 1,
      "plateNumber": "沪F44444",
      "violationType": "闯红灯",
      "imageUrl": "http://localhost:9000/traffic-violations/batch_001.jpg",
      "confidence": 0.96,
      "cameraId": "cam-001"
    },
    {
      "intersectionId": 1,
      "plateNumber": "沪G55555",
      "violationType": "逆行",
      "imageUrl": "http://localhost:9000/traffic-violations/batch_002.jpg",
      "confidence": 0.89,
      "cameraId": "cam-002"
    }
  ],
  "cameraId": "cam-batch",
  "videoInfo": {
    "filename": "traffic_video_20241219.mp4",
    "duration": 300
  }
}

### 10. 图片上传并检测 - 需要multipart/form-data
# POST http://localhost:8081/api/violation-detection/upload-image
# Content-Type: multipart/form-data
# 
# image=@/path/to/violation_image.jpg
# intersectionId=1
# plateNumber=沪H66666
# violationType=闯红灯
# aiConfidence=0.94

### 11. 视频上传 - 手动模式（仅上传）
# POST http://localhost:8081/api/violation-detection/upload-video
# Content-Type: multipart/form-data
#
# video=@/path/to/traffic_video.mp4
# intersectionId=1
# cameraId=cam-upload
# autoAnalyze=false

### 11.1 视频上传 - 自动帧分析模式
# POST http://localhost:8081/api/violation-detection/upload-video
# Content-Type: multipart/form-data
#
# video=@/path/to/traffic_video.mp4
# intersectionId=1
# cameraId=cam-upload
# autoAnalyze=true

### 11.2 查询视频分析任务状态
GET http://localhost:8081/api/violation-detection/task-status/task_1703001234567

### 12. 查询违章记录列表
GET http://localhost:8081/api/violations?page=1&size=10

### 13. 查询违章详情
GET http://localhost:8081/api/violations/1

###############################################
# 红绿灯状态测试场景
###############################################

### 场景1: 红灯期间闯红灯 - 应该成功记录违章
POST http://localhost:8081/api/violation-detection/simulate-light
Content-Type: application/x-www-form-urlencoded

intersectionId=2&lightState=RED&duration=60

###
POST http://localhost:8081/api/violation-detection/detect-frame
Content-Type: application/json

{
  "intersectionId": 2,
  "plateNumber": "测试001",
  "violationType": "RED_LIGHT",
  "imageUrl": "http://localhost:9000/traffic-violations/test_red_light.jpg",
  "confidence": 0.95,
  "cameraId": "test-cam"
}

### 场景2: 绿灯期间"闯红灯" - 应该被拒绝
POST http://localhost:8081/api/violation-detection/simulate-light
Content-Type: application/x-www-form-urlencoded

intersectionId=2&lightState=GREEN&duration=60

###
POST http://localhost:8081/api/violation-detection/detect-frame
Content-Type: application/json

{
  "intersectionId": 2,
  "plateNumber": "测试002",
  "violationType": "RED_LIGHT",
  "imageUrl": "http://localhost:9000/traffic-violations/test_green_light.jpg",
  "confidence": 0.95,
  "cameraId": "test-cam"
}

###############################################
# 视频自动分析测试
###############################################

### 测试视频自动分析 (需要使用Postman或其他支持文件上传的工具)
### 创建一个示例请求 - 在Postman中设置：
### Method: POST
### URL: http://localhost:8081/api/violation-detection/upload-video
### Body: form-data
### - Key: video, Type: File, Value: 选择视频文件
### - Key: intersectionId, Type: Text, Value: 1
### - Key: cameraId, Type: Text, Value: test-cam
### - Key: autoAnalyze, Type: Text, Value: true

### 查询任务状态示例
GET http://localhost:8081/api/violation-detection/task-status/task_1734585600000

### 查询所有违章记录查看自动检测结果
GET http://localhost:8081/api/violations?page=1&size=20

###############################################
# 转弯违规与红绿灯联动测试
###############################################

### 场景3: 红灯期间违法转弯 - 应该构成违章
POST http://localhost:8081/api/violation-detection/simulate-light
Content-Type: application/x-www-form-urlencoded

intersectionId=3&lightState=RED&duration=90

###
POST http://localhost:8081/api/violation-detection/detect-frame
Content-Type: application/json

{
  "intersectionId": 3,
  "plateNumber": "转弯001",
  "violationType": "违法转弯",
  "imageUrl": "http://localhost:9000/traffic-violations/illegal_turn_red.jpg",
  "confidence": 0.92,
  "cameraId": "turn-cam",
  "description": "红灯时进入待转区域"
}

### 场景4: 黄灯期间违法转弯 - 应该构成违章
POST http://localhost:8081/api/violation-detection/simulate-light
Content-Type: application/x-www-form-urlencoded

intersectionId=3&lightState=YELLOW&duration=30

###
POST http://localhost:8081/api/violation-detection/detect-frame
Content-Type: application/json

{
  "intersectionId": 3,
  "plateNumber": "转弯002", 
  "violationType": "违法转弯",
  "imageUrl": "http://localhost:9000/traffic-violations/illegal_turn_yellow.jpg",
  "confidence": 0.89,
  "cameraId": "turn-cam",
  "description": "黄灯时新进入待转区域"
}

### 场景5: 绿灯期间转弯 - 不应该构成违章（合法转弯）
POST http://localhost:8081/api/violation-detection/simulate-light
Content-Type: application/x-www-form-urlencoded

intersectionId=3&lightState=GREEN&duration=60

###
POST http://localhost:8081/api/violation-detection/detect-frame
Content-Type: application/json

{
  "intersectionId": 3,
  "plateNumber": "转弯003",
  "violationType": "违法转弯", 
  "imageUrl": "http://localhost:9000/traffic-violations/turn_green.jpg",
  "confidence": 0.95,
  "cameraId": "turn-cam",
  "description": "绿灯时转弯（应该被拒绝，因为绿灯时转弯是合法的）"
}

### 验证当前红绿灯状态
GET http://localhost:8081/api/violation-detection/light-state/3

###############################################
# 综合测试：多种违章类型的红绿灯联动
###############################################

### 批量测试：不同灯色下的各种违章
POST http://localhost:8081/api/violation-detection/detect-batch
Content-Type: application/json

{
  "violations": [
    {
      "intersectionId": 4,
      "plateNumber": "综合001",
      "violationType": "闯红灯",
      "imageUrl": "http://localhost:9000/traffic-violations/comprehensive_red_light.jpg", 
      "confidence": 0.96,
      "cameraId": "comprehensive-cam",
      "note": "需要红灯状态下才构成违章"
    },
    {
      "intersectionId": 4,
      "plateNumber": "综合002", 
      "violationType": "违法转弯",
      "imageUrl": "http://localhost:9000/traffic-violations/comprehensive_illegal_turn.jpg",
      "confidence": 0.91,
      "cameraId": "comprehensive-cam",
      "note": "需要红灯或黄灯状态下才构成违章"
    },
    {
      "intersectionId": 4,
      "plateNumber": "综合003",
      "violationType": "逆行", 
      "imageUrl": "http://localhost:9000/traffic-violations/comprehensive_wrong_way.jpg",
      "confidence": 0.94,
      "cameraId": "comprehensive-cam",
      "note": "不受红绿灯影响，始终构成违章"
    },
    {
      "intersectionId": 4,
      "plateNumber": "综合004",
      "violationType": "跨实线",
      "imageUrl": "http://localhost:9000/traffic-violations/comprehensive_cross_line.jpg", 
      "confidence": 0.87,
      "cameraId": "comprehensive-cam",
      "note": "不受红绿灯影响，始终构成违章"
    }
  ]
}