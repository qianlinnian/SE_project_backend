# TrafficMind API 测试集合
# 使用 VS Code REST Client 插件执行

### 变量定义
@baseUrl = http://localhost:8081/api
@token = YOUR_TOKEN_HERE
@contentType = application/json

###############################################
# 0. 健康检查
###############################################

### 0.1 健康检查
GET {{baseUrl}}/health

### 0.2 根路径欢迎信息
GET {{baseUrl}}/

###############################################
# Module 1: 用户与权限管理
###############################################

### 1. 用户登录（获取 Token）
# @name login
POST {{baseUrl}}/auth/login
Content-Type: {{contentType}}

{
  "username": "admin",
  "password": "password123"
}

### 提取 Token
@token = {{login.response.body.data.accessToken}}

### 2. 获取当前用户信息
GET {{baseUrl}}/auth/me
Authorization: Bearer {{token}}

### 3. 用户登出
POST {{baseUrl}}/auth/logout
Authorization: Bearer {{token}}

###############################################
# Module 1: 管理员 - 交警管理
###############################################

### 4. 创建交警账号
POST {{baseUrl}}/admin/police
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

{
  "username": "police_test01",
  "password": "password123",
  "fullName": "测试交警",
  "policeNumber": "PC0001"
}

### 5. 获取交警列表（分页）
GET {{baseUrl}}/admin/police?page=1&size=10
Authorization: Bearer {{token}}

### 6. 启用/停用交警账号
PUT {{baseUrl}}/admin/police/2/status
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

{
  "status": "SUSPENDED"
}

### 7. 恢复交警账号
PUT {{baseUrl}}/admin/police/2/status
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

{
  "status": "ACTIVE"
}

###############################################
# Module 1: Redis 测试 API (From Postman)
###############################################

### 1.1 设置路口流量状态
POST {{baseUrl}}/redis-test/traffic/intersection-1
Content-Type: {{contentType}}

### 1.2 获取路口流量状态
GET {{baseUrl}}/redis-test/traffic/intersection-1

### 1.3 增加违章计数
POST {{baseUrl}}/redis-test/violation

### 1.4 获取违章总数
GET {{baseUrl}}/redis-test/violations

###############################################
# Module 2: 交通监控 API (From Postman)
###############################################

### 2.1 获取所有路口列表
GET {{baseUrl}}/intersections

### 2.2 设置路口数据（测试用）
POST {{baseUrl}}/intersections/intersection-1
Content-Type: {{contentType}}

{
  "flow": 150,
  "status": "NORMAL",
  "timestamp": 1702400000,
  "congestionLevel": 2
}

### 2.3 获取路口实时数据
GET {{baseUrl}}/intersections/intersection-1/realtime

### 2.4 设置统计数据（测试用）
POST {{baseUrl}}/dashboard/stats
Content-Type: {{contentType}}

{
  "totalViolations": 150,
  "averageCongestionLevel": 2.5,
  "peakHours": "08:00-09:00, 17:00-18:00",
  "safeIntersections": 10,
  "problematicIntersections": 3
}

### 2.5 获取统计数据
GET {{baseUrl}}/dashboard/stats

### 2.6 设置热力图数据（测试用）
POST {{baseUrl}}/dashboard/heatmap
Content-Type: {{contentType}}

[
  {
    "latitude": 39.9042,
    "longitude": 116.4074,
    "congestionLevel": 3,
    "name": "东直门交叉口"
  },
  {
    "latitude": 39.9084,
    "longitude": 116.4065,
    "congestionLevel": 2,
    "name": "朝阳门交叉口"
  },
  {
    "latitude": 39.9027,
    "longitude": 116.4074,
    "congestionLevel": 1,
    "name": "建国门交叉口"
  }
]

### 2.7 获取热力图数据
GET {{baseUrl}}/dashboard/heatmap

###############################################
# Module 3: 违章管理 API (From Postman)
###############################################

### 3.1 上报违章行为 (旧格式兼容)
POST {{baseUrl}}/violations/report
Content-Type: {{contentType}}

{
  "type": "speeding",
  "intersectionId": "intersection-1",
  "vehicleId": "vehicle-001",
  "timestamp": 1702400000,
  "speed": 85,
  "description": "超速行驶"
}

### 3.1.1 上报违章行为 (新格式 - 包含方向信息，供AI调用)
POST {{baseUrl}}/violations/report
Content-Type: {{contentType}}

{
  "intersectionId": 1,
  "direction": "SOUTH",
  "turnType": "STRAIGHT",
  "plateNumber": "京A12345",
  "violationType": "RED_LIGHT",
  "imageUrl": "https://minio.example.com/violations/frame_001.jpg",
  "aiConfidence": 0.95
}

### 3.1.2 上报闯红灯违章 (AI调用示例)
POST {{baseUrl}}/violations/report
Content-Type: {{contentType}}

{
  "intersectionId": 1,
  "direction": "EAST",
  "turnType": "LEFT_TURN",
  "plateNumber": "沪B66666",
  "violationType": "RED_LIGHT",
  "imageUrl": "https://minio.example.com/violations/red_light_001.jpg",
  "aiConfidence": 0.92
}

### 3.1.3 上报逆行违章 (AI调用示例)
POST {{baseUrl}}/violations/report
Content-Type: {{contentType}}

{
  "intersectionId": 2,
  "direction": "NORTH",
  "turnType": "STRAIGHT",
  "plateNumber": "粤C88888",
  "violationType": "WRONG_WAY",
  "imageUrl": "https://minio.example.com/violations/wrong_way_001.jpg",
  "aiConfidence": 0.88
}

### 3.1.4 上报压实线违章 (AI调用示例)
POST {{baseUrl}}/violations/report
Content-Type: {{contentType}}

{
  "intersectionId": 1,
  "direction": "WEST",
  "turnType": "RIGHT_TURN",
  "plateNumber": "苏D99999",
  "violationType": "CROSS_SOLID_LINE",
  "imageUrl": "https://minio.example.com/violations/cross_line_001.jpg",
  "aiConfidence": 0.90
}

### 3.1.5 上报违法转弯违章 (AI调用示例)
POST {{baseUrl}}/violations/report
Content-Type: {{contentType}}

{
  "intersectionId": 1,
  "direction": "SOUTH",
  "turnType": "LEFT_TURN",
  "plateNumber": "浙E11111",
  "violationType": "ILLEGAL_TURN",
  "imageUrl": "https://minio.example.com/violations/illegal_turn_001.jpg",
  "aiConfidence": 0.85
}

### 3.2 查询违章列表（分页）
GET {{baseUrl}}/violations?page=1&size=10

### 3.3 查看违章详情
GET {{baseUrl}}/violations/violation-1

### 3.4 处理违章
PUT {{baseUrl}}/violations/violation-1/process
Content-Type: {{contentType}}

{
  "status": "processed",
  "processorId": "admin-001",
  "processTime": 1702400100,
  "fine": 500,
  "description": "已处罚"
}

### 3.5 增加违章计数（测试用）
POST {{baseUrl}}/violations/increment

### 3.6 获取违章总数（测试用）
GET {{baseUrl}}/violations/count

###############################################
# Module 4: 智能信号灯控制
###############################################

### 8. 调整信号灯配置（路口ID=1）
POST {{baseUrl}}/signals/1/adjust
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

{
  "mode": "INTELLIGENT",
  "greenDuration": 45,
  "reason": "Traffic congestion detected"
}

### 9. 查询单个路口信号灯配置
GET {{baseUrl}}/signals/1/config
Authorization: Bearer {{token}}

### 10. 查询所有路口信号灯配置
GET {{baseUrl}}/signals
Authorization: Bearer {{token}}

### 11. 手动模式调整信号灯
POST {{baseUrl}}/signals/1/adjust
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

{
  "mode": "MANUAL",
  "greenDuration": 60,
  "redDuration": 30,
  "yellowDuration": 3,
  "reason": "晚高峰手动调整"
}

### 12. 固定模式调整信号灯
POST {{baseUrl}}/signals/1/adjust
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

{
  "mode": "FIXED",
  "greenDuration": 30,
  "redDuration": 30,
  "yellowDuration": 3,
  "reason": "夜间固定模式"
}

###############################################
# 其他可选测试
###############################################

### MinIO 健康检查
GET http://localhost:9000/minio/health/live

###############################################
# Module 5: AI集成与视频分析 (新增功能)
###############################################

### 5.1 测试接口 - 基础健康检查
GET {{baseUrl}}/test/health

### 5.2 AI服务状态检查
GET {{baseUrl}}/ai-integration/status
Authorization: Bearer {{token}}

### 5.3 视频上传分析 - 单个方向
# 注意：这需要multipart/form-data格式，实际使用时需要用工具如Postman
POST {{baseUrl}}/violation-detection/upload-video-for-analysis
Authorization: Bearer {{token}}
Content-Type: multipart/form-data

# 参数说明:
# - video: 视频文件
# - intersectionId: 路口ID (如: 1)  
# - direction: 方向 (EAST/SOUTH/WEST/NORTH)

### 5.4 批量多方向视频上传
POST {{baseUrl}}/violation-detection/upload-multi-direction-videos
Authorization: Bearer {{token}}
Content-Type: multipart/form-data

# 参数说明:
# - intersectionId: 路口ID
# - eastVideo: 东向视频(可选)
# - southVideo: 南向视频(可选) 
# - westVideo: 西向视频(可选)
# - northVideo: 北向视频(可选)

### 5.5 AI结果回调 - 单个违章检测结果 (AI同学调用)
POST {{baseUrl}}/violation-detection/ai-callback
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

{
  "taskId": "550e8400-e29b-41d4-a716-446655440000",
  "plateNumber": "沪A12345",
  "violationType": "闯红灯",
  "confidence": 0.95,
  "turnType": "STRAIGHT",
  "frameTimestamp": 15.2,
  "boundingBox": {
    "x": 100,
    "y": 150,
    "width": 200,
    "height": 120
  },
  "imageUrl": "http://minio:9000/violations/violation_frame_15_2.jpg"
}

### 5.6 AI结果回调 - 批量违章检测结果 (AI同学调用)
POST {{baseUrl}}/violation-detection/ai-callback
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

{
  "taskId": "550e8400-e29b-41d4-a716-446655440001",
  "results": [
    {
      "plateNumber": "京B66666",
      "violationType": "违法转弯",
      "confidence": 0.88,
      "turnType": "LEFT_TURN",
      "frameTimestamp": 25.5,
      "boundingBox": {"x": 150, "y": 200, "width": 180, "height": 100}
    },
    {
      "plateNumber": "粤C88888", 
      "violationType": "逆行",
      "confidence": 0.92,
      "turnType": "STRAIGHT",
      "frameTimestamp": 45.8,
      "boundingBox": {"x": 300, "y": 250, "width": 220, "height": 130}
    }
  ]
}

### 5.7 AI分析完成通知 (AI同学调用)
POST {{baseUrl}}/violation-detection/ai-completed  
Content-Type: {{contentType}}

{
  "taskId": "550e8400-e29b-41d4-a716-446655440000",
  "totalDetections": 3,
  "processingTime": "00:02:45",
  "status": "completed"
}

### 5.8 查询任务状态
GET {{baseUrl}}/violation-detection/task/550e8400-e29b-41d4-a716-446655440000/status

### 5.9 查询路口所有任务 (分页)
GET {{baseUrl}}/violation-detection/intersection/1/tasks?page=0&size=10

### 5.10 获取任务统计信息
GET {{baseUrl}}/violation-detection/tasks/statistics

### 5.11 原有的违章检测接口 (现在支持多方向)
POST {{baseUrl}}/violation-detection/detect-frame
Content-Type: {{contentType}}

{
  "intersectionId": 1,
  "direction": "SOUTH",
  "turnType": "LEFT_TURN",
  "plateNumber": "沪A12345",
  "violationType": "闯红灯",
  "imageUrl": "http://minio:9000/test.jpg", 
  "confidence": 0.95
}

### 5.12 方向特定违章检测 - 南向
POST {{baseUrl}}/violation-detection/directions/SOUTH/detect-frame
Content-Type: {{contentType}}

{
  "intersectionId": 1,
  "plateNumber": "京B77777",
  "violationType": "违法转弯",
  "confidence": 0.89
}

### 5.13 方向特定违章检测 - 东向闯红灯
POST {{baseUrl}}/violation-detection/directions/EAST/detect-frame
Content-Type: {{contentType}}

{
  "intersectionId": 1,
  "plateNumber": "沪C88888",
  "violationType": "闯红灯",
  "turnType": "STRAIGHT",
  "imageUrl": "http://minio:9000/violations/east_redlight.jpg",
  "confidence": 0.93
}

### 5.14 方向特定违章检测 - 西向逆行
POST {{baseUrl}}/violation-detection/directions/WEST/detect-frame
Content-Type: {{contentType}}

{
  "intersectionId": 1,
  "plateNumber": "粤D99999",
  "violationType": "逆行",
  "turnType": "STRAIGHT",
  "imageUrl": "http://minio:9000/violations/west_wrongway.jpg",
  "confidence": 0.96
}

### 5.15 方向特定违章检测 - 北向压实线
POST {{baseUrl}}/violation-detection/directions/NORTH/detect-frame
Content-Type: {{contentType}}

{
  "intersectionId": 2,
  "plateNumber": "苏E11111",
  "violationType": "压实线",
  "turnType": "LEFT_TURN",
  "imageUrl": "http://minio:9000/violations/north_crossline.jpg",
  "confidence": 0.87
}

###############################################
# Module 6: 多方向信号灯控制 (增强功能)
###############################################

### 6.1 查看多方向信号灯状态
GET {{baseUrl}}/multi-direction-traffic/intersections/1/status

### 6.2 查看特定方向转向的信号灯状态
GET {{baseUrl}}/multi-direction-traffic/intersections/1/directions/SOUTH/turns/LEFT_TURN/status

### 6.3 模拟设置信号灯状态 (测试用)
POST {{baseUrl}}/multi-direction-traffic/intersections/1/simulate
Content-Type: {{contentType}}

{
  "direction": "SOUTH",
  "turnType": "LEFT_TURN", 
  "lightPhase": "RED",
  "duration": 30
}

### 6.4 获取信号灯配置详情
GET {{baseUrl}}/multi-direction-traffic/intersections/1/directions/SOUTH/config

### 6.5 获取路口所有方向配置
GET {{baseUrl}}/multi-direction-traffic/intersections/1/directions

### 6.6 验证违章是否成立 (结合信号灯状态)
POST {{baseUrl}}/multi-direction-traffic/intersections/1/validate-violation
Content-Type: {{contentType}}

{
  "direction": "SOUTH",
  "turnType": "STRAIGHT",
  "violationType": "RED_LIGHT"
}

### 6.7 验证违法转弯
POST {{baseUrl}}/multi-direction-traffic/intersections/1/validate-violation
Content-Type: {{contentType}}

{
  "direction": "EAST",
  "turnType": "LEFT_TURN",
  "violationType": "ILLEGAL_TURN"
}

### 6.8 验证逆行 (始终构成违章)
POST {{baseUrl}}/multi-direction-traffic/intersections/1/validate-violation
Content-Type: {{contentType}}

{
  "direction": "NORTH",
  "turnType": "STRAIGHT",
  "violationType": "WRONG_WAY"
}

### 6.9 验证压实线 (始终构成违章)
POST {{baseUrl}}/multi-direction-traffic/intersections/1/validate-violation
Content-Type: {{contentType}}

{
  "direction": "WEST",
  "turnType": "RIGHT_TURN",
  "violationType": "CROSS_SOLID_LINE"
}

### 6.10 清除路口缓存
DELETE {{baseUrl}}/multi-direction-traffic/intersections/1/cache

### 6.11 获取支持的方向和类型元数据
GET {{baseUrl}}/multi-direction-traffic/metadata

###############################################
# Module 7: AI集成和视频分析 (新增功能)
###############################################

### 7.1 测试基础健康检查
GET {{baseUrl}}/test/health
Authorization: Bearer {{token}}

### 7.2 AI服务状态检查
GET {{baseUrl}}/ai-integration/status
Authorization: Bearer {{token}}

### 7.2.1 AI服务健康检查
GET {{baseUrl}}/ai-integration/health
Authorization: Bearer {{token}}

### 7.3 单个方向视频上传分析
POST {{baseUrl}}/violation-detection/upload-video-for-analysis
Authorization: Bearer {{token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary

------WebKitFormBoundary
Content-Disposition: form-data; name="video"; filename="test_video.mp4"
Content-Type: video/mp4

< ./test_video.txt
------WebKitFormBoundary
Content-Disposition: form-data; name="intersectionId"

1
------WebKitFormBoundary
Content-Disposition: form-data; name="direction"

SOUTH
------WebKitFormBoundary--

### 7.4 AI检测结果回调 (AI模型调用)
POST {{baseUrl}}/violation-detection/ai-callback
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

{
  "taskId": "550e8400-e29b-41d4-a716-446655440000",
  "plateNumber": "沪A12345",
  "violationType": "闯红灯",
  "confidence": 0.95,
  "turnType": "STRAIGHT",
  "frameTimestamp": 15.2,
  "boundingBox": {
    "x": 100,
    "y": 150,
    "width": 200,
    "height": 120
  },
  "imageUrl": "http://localhost:9000/violations/violation_frame.jpg"
}

### 7.5 AI分析完成通知
POST {{baseUrl}}/violation-detection/ai-completed
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

{
  "taskId": "550e8400-e29b-41d4-a716-446655440000",
  "totalDetections": 3,
  "processingTime": "00:02:45",
  "status": "completed"
}

### 7.6 查询任务状态
GET {{baseUrl}}/violation-detection/task/550e8400-e29b-41d4-a716-446655440000/status
Authorization: Bearer {{token}}

### 7.7 查询路口任务列表
GET {{baseUrl}}/violation-detection/intersection/1/tasks?page=0&size=10
Authorization: Bearer {{token}}

### 7.8 获取任务统计信息
GET {{baseUrl}}/violation-detection/tasks/statistics
Authorization: Bearer {{token}}

### 7.9 批量AI结果回调
POST {{baseUrl}}/violation-detection/ai-callback
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

{
  "taskId": "550e8400-e29b-41d4-a716-446655440001",
  "results": [
    {
      "plateNumber": "京B66666",
      "violationType": "违法转弯",
      "confidence": 0.88,
      "turnType": "LEFT_TURN",
      "frameTimestamp": 25.5
    },
    {
      "plateNumber": "粤C88888",
      "violationType": "逆行",
      "confidence": 0.92,
      "turnType": "STRAIGHT", 
      "frameTimestamp": 45.8
    }
  ]
}

### 7.10 基础违章检测接口 (兼容原有)
POST {{baseUrl}}/violation-detection/detect-frame
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

{
  "intersectionId": 1,
  "direction": "SOUTH",
  "turnType": "STRAIGHT",
  "plateNumber": "测试A123",
  "violationType": "闯红灯",
  "imageUrl": "http://test.jpg",
  "confidence": 0.95
}

###############################################
# Module 8: 智能信号灯后端对接 (Module 4 增强)
# 文档来源: 智能信号灯板块.pdf
# 说明：包含 LLM 数据推送接收、前端查询及控制指令转发
###############################################

### 8.1 接收 LLM 推送的实时交通数据 (模拟 LLM 调用)
# 对应接口: 1.1 接收LLM服务器推送的数据
# 对应 Controller: TrafficIngestionController
POST {{baseUrl}}/traffic
Content-Type: {{contentType}}

{
  "timestamp": 120.5,
  "step": 105,
  "roadnet": "Hangzhou-4_4",
  "trafficflow": "anon_4_4_hangzhou_real",
  "control_mode": "ai",
  "total_intersections": 1,
  "intersections": [
    {
      "id": 0,
      "signal_phase": "ETWT",
      "phase_code": 0,
      "queue_length": 12,
      "vehicle_count": 25,
      "lanes": {
        "NT": { "cells": [1, 2, 0, 0], "queue_len": 3 },
        "NL": { "cells": [0, 1, 0, 0], "queue_len": 1 },
        "ST": { "cells": [2, 1, 0, 0], "queue_len": 2 },
        "SL": { "cells": [0, 0, 0, 0], "queue_len": 0 },
        "ET": { "cells": [1, 0, 1, 0], "queue_len": 1 },
        "EL": { "cells": [0, 0, 0, 0], "queue_len": 0 },
        "WT": { "cells": [0, 1, 0, 0], "queue_len": 1 },
        "WL": { "cells": [0, 0, 0, 0], "queue_len": 0 }
      }
    }
  ]
}

### 8.2 前端获取最新交通数据 (实时轮询用)
# 对应接口: 1.2 前端获取最新交通数据
# 对应 Controller: TrafficQueryController
# 说明：此数据来自 Redis 缓存
GET {{baseUrl}}/traffic/latest
Authorization: Bearer {{token}}

### 8.3 前端获取交通数据历史记录 (图表展示用)
# 对应接口: 1.3 获取交通数据历史记录
# 对应 Controller: TrafficQueryController
# 说明：数据来自 MySQL 全量历史表 traffic_flow_records
GET {{baseUrl}}/traffic/history?limit=20
Authorization: Bearer {{token}}

### 8.4 切换控制模式 (前端 -> 后端 -> LLM)
# 对应接口: 2.1 切换控制模式
# 对应 Controller: SignalControlController
# 逻辑：1.转发给LLM 2.更新本地数据库 3.WebSocket广播
# 可选值: "ai", "fixed"
POST {{baseUrl}}/control/mode
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

{
  "mode": "fixed"
}

### 8.5 设置固定配时周期 (前端 -> 后端 -> LLM)
# 对应接口: 2.2 设置固定配时周期
# 对应 Controller: SignalControlController
# 说明：仅在 fixed 模式下有效，时长范围 10-120 秒
POST {{baseUrl}}/control/fixed-duration
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

{
  "duration": 60
}

### 8.6 获取当前控制状态
# 对应接口: 2.3 获取当前控制状态
# 对应 Controller: SignalControlController
# 说明：返回真实的 DB 配置状态和 LLM 连接状态
GET {{baseUrl}}/control/status
Authorization: Bearer {{token}}

### 8.7 获取系统整体状态
# 对应接口: 3.1 获取系统状态
# 对应 Controller: SystemStatusController
# 说明：返回后端运行时间、LLM 连接状态、最后一次数据接收时间
GET {{baseUrl}}/system/status
Authorization: Bearer {{token}}